<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××—×©×‘×•×Ÿ ×©×›×¨ | ×œ×©×›×ª ×¢×•×¨×›×™ ×”×“×™×Ÿ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; transition: background 0.4s ease; min-height: 100vh; margin: 0; }
        .dark-mode { background-color: #0f172a; color: white; }
        .light-mode { background-color: #f1f5f9; color: #1e293b; }
        @media (min-width: 1024px) {
            body { overflow: hidden; height: 100vh; }
            .main-container { height: 100vh; display: flex; flex-direction: column; }
            .scroll-area { max-height: calc(100vh - 480px); overflow-y: auto; }
        }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 10px; }
        .btn-premium { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .num-btn { transition: all 0.1s; display: flex; align-items: center; justify-content: center; font-weight: 900; border-radius: 12px; cursor: pointer; }
        .num-btn:active { transform: scale(0.92); }
        .dark-mode .num-btn { background: #1e293b; border: 1px solid #334155; }
        .dark-mode .display-box { background: #020617; border: 2px solid #334155; color: #f59e0b; }
        .dark-mode .bg-custom-card { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(51, 65, 85, 0.5); }
        .light-mode .num-btn { background: white; border: 1px solid #cbd5e1; color: #1e293b; }
        .light-mode .display-box { background: white; border: 2px solid #cbd5e1; color: #d97706; }
        .light-mode .bg-custom-card { background: white; border: 1px solid #cbd5e1; }
    </style>
</head>
<body class="p-4 md:p-8 dark-mode" id="mainBody">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;

        function App() {
            const [history, setHistory] = useState([]);
            const [gross, setGross] = useState('');
            const [restoreCode, setRestoreCode] = useState('');
            const [isArchiveOpen, setIsArchiveOpen] = useState(false);
            const [multiCodes, setMultiCodes] = useState('');
            const [copied, setCopied] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(true);

            // ×¤×•× ×§×¦×™×™×ª ×”×—×™×©×•×‘ ×”××¨×›×–×™×ª - ××©×ª××©×™× ×‘-useCallback ×›×“×™ ×©×ª×”×™×” ×–××™× ×” ×œ×›×•×œ×
            const calculateValue = useCallback((val) => {
                const n = parseFloat(val);
                if (isNaN(n) || n <= 0) return { net: 0, deduction: 0 };
                let net, deduction;
                if (n === 15000 || n === 20000) { 
                    net = (n - 8000) * 0.8; 
                    deduction = (n - 8000) * 0.2; 
                } else { 
                    net = n * 0.8; 
                    deduction = n * 0.2; 
                }
                return { net, deduction };
            }, []);

            useEffect(() => {
                document.getElementById('mainBody').className = `p-4 md:px-12 md:py-8 ${isDarkMode ? 'dark-mode' : 'light-mode'}`;
            }, [isDarkMode]);

            const onAdd = (valueToAdd = null) => {
                const finalGross = valueToAdd !== null ? valueToAdd : parseFloat(gross);
                if (isNaN(finalGross) || finalGross <= 0) return;
                const v = calculateValue(finalGross);
                setHistory(prev => [{ id: Math.random(), gross: finalGross, net: v.net, deduction: v.deduction }, ...prev]);
                if (valueToAdd === null) setGross('');
            };

            const fmt = (num) => new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }).format(num);

            // ×œ×•×’×™×§×ª ×”××¨×›×™×•×Ÿ ×•×”×¡×™×›×•× ×”××ª×•×§× ×ª
            const combinedNet = useMemo(() => {
                let total = 0;
                if (!multiCodes.trim()) return 0;
                
                // ×¤×™×¦×•×œ ×œ×¤×™ ×¨×•×•×—×™× ××• ×©×•×¨×•×ª ×—×“×©×•×ª
                const codes = multiCodes.split(/[\s\n]+/);
                
                codes.forEach(code => {
                    if (!code.trim()) return;
                    try {
                        const decoded = JSON.parse(atob(code.trim()));
                        if (Array.isArray(decoded)) {
                            decoded.forEach(val => {
                                total += calculateValue(val).net;
                            });
                        }
                    } catch (e) {
                        console.error("×©×’×™××” ×‘×¤×¢× ×•×— ×§×•×“:", code);
                    }
                });
                return total;
            }, [multiCodes, calculateValue]);

            const totalNet = history.reduce((s, i) => s + i.net, 0);

            return (
                <div className="max-w-7xl mx-auto main-container">
                    <header className="flex justify-between items-center mb-6">
                        <div className="text-right">
                            <h1 className="text-2xl md:text-4xl font-black">××¢×¨×›×ª ×—×™×©×•×‘ ×©×›×¨</h1>
                            <p className="text-amber-500 font-bold text-sm">×œ×©×›×ª ×¢×•×¨×›×™ ×”×“×™×Ÿ ×‘×™×©×¨××œ</p>
                        </div>
                        <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-3 bg-slate-800 rounded-full border border-slate-700">
                            {isDarkMode ? 'ğŸŒ' : 'ğŸŒ™'}
                        </button>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:overflow-hidden">
                        <div className="lg:col-span-5 space-y-4">
                            <div className="bg-custom-card p-6 rounded-3xl shadow-xl">
                                <div className="display-box p-4 rounded-2xl text-4xl md:text-5xl font-black text-center mb-6 h-24 flex items-center justify-center shadow-inner">
                                    {gross || '0'}
                                </div>
                                <div className="grid grid-cols-3 gap-3">
                                    {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => <button key={n} onClick={() => setGross(prev => prev + n)} className="num-btn h-16 md:h-20 text-2xl">{n}</button>)}
                                    <button onClick={() => setGross('')} className="num-btn bg-slate-700 text-white h-16 text-xl">C</button>
                                    <button onClick={() => setGross(prev => prev + '0')} className="num-btn h-16 text-2xl">0</button>
                                    <button onClick={() => setGross(prev => prev.slice(0, -1))} className="num-btn bg-slate-700 text-white h-16 text-xl">âŒ«</button>
                                    <button onClick={() => onAdd()} className="col-span-3 btn-premium text-slate-950 font-black py-5 rounded-xl text-2xl mt-4 active:scale-95 shadow-lg">×”×•×¡×£ ×œ×¨×©×™××” +</button>
                                </div>
                            </div>
                            <div className="bg-slate-800 p-6 rounded-3xl border-t-4 border-amber-500 shadow-xl text-white">
                                <span className="text-slate-400 block text-[10px] font-black uppercase text-right">×¡×”"×› × ×˜×• ×‘×¨×©×™××”:</span>
                                <div className="text-4xl md:text-5xl font-black text-right">{fmt(totalNet)}</div>
                            </div>
                        </div>

                        <div className="lg:col-span-7 flex flex-col">
                            <div className="flex justify-between items-center mb-4 px-2">
                                <h2 className="text-sm font-black text-slate-400 uppercase tracking-widest">×¤×™×¨×•×˜ ×¢×¡×§××•×ª ({history.length})</h2>
                                <div className="flex gap-2">
                                    <button onClick={() => { 
                                        const code = btoa(JSON.stringify(history.map(i => i.gross)));
                                        navigator.clipboard.writeText(code);
                                        setCopied(true);
                                        setTimeout(() => setCopied(false), 2000);
                                    }} className="text-[10px] bg-slate-700 text-white px-3 py-1 rounded-full font-bold">
                                        {copied ? 'âœ… ×”×•×¢×ª×§' : 'ğŸ“‹ ×”×¢×ª×§ ×§×•×“ ×¨×©×™××”'}
                                    </button>
                                    <button onClick={() => setHistory([])} className="text-[10px] text-red-500 border border-red-500/30 px-3 py-1 rounded-full font-bold">× ×§×”</button>
                                </div>
                            </div>
                            <div className="scroll-area space-y-3 pb-10 px-1">
                                {history.map((item, idx) => (
                                    <div key={item.id} className="bg-custom-card p-4 rounded-2xl flex justify-between items-center shadow-md border border-slate-700/20">
                                        <div className="text-right">
                                            <p className="font-bold text-lg mb-1">{fmt(item.gross)}</p>
                                            <p className="text-[10px] text-red-400 font-bold uppercase tracking-tight">× ×™×›×•×™: {fmt(item.deduction)}</p>
                                        </div>
                                        <div className="text-left font-black text-2xl text-emerald-500">+{fmt(item.net)}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="mt-auto pt-6 border-t border-slate-800/50 pb-8">
                        <button onClick={() => setIsArchiveOpen(!isArchiveOpen)} className="w-full bg-slate-800/40 p-4 rounded-2xl flex justify-between items-center mb-4 border border-slate-700/30">
                            <span className="font-bold text-slate-400 text-xs uppercase tracking-widest">ğŸ“‚ ××¨×›×™×•×Ÿ ×•×¡×™×›×•× (×”×“×‘×§ ×›××Ÿ ×§×•×“×™×)</span>
                            <span className="text-slate-400">{isArchiveOpen ? 'â–²' : 'â–¼'}</span>
                        </button>
                        {isArchiveOpen && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-900/50 p-4 rounded-2xl mb-4 border border-slate-800">
                                <textarea 
                                    value={multiCodes} 
                                    onChange={(e) => setMultiCodes(e.target.value)} 
                                    className="w-full h-32 bg-slate-950 border border-slate-700 rounded-xl p-3 text-[10px] text-emerald-400 font-mono outline-none resize-none text-left" 
                                    placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”×§×•×“×™× ×©×”×¢×ª×§×ª (××—×“ ××ª×—×ª ×œ×©× ×™)..." 
                                />
                                <div className="flex flex-col justify-center text-right p-6 bg-slate-800/50 rounded-xl border border-slate-700">
                                    <span className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">× ×˜×• ××©×•×œ×‘ ××›×œ ×”×§×•×“×™×:</span>
                                    <div className="text-4xl font-black text-emerald-400 mt-2">{fmt(combinedNet)}</div>
                                    <button onClick={() => setMultiCodes('')} className="text-right text-[10px] text-slate-500 underline mt-4">× ×§×” ×ª×™×‘×ª ××¨×›×™×•×Ÿ</button>
                                </div>
                            </div>
                        )}
                        <footer className="text-center">
                            <div className="text-amber-500 font-black text-[11px] italic">× ×‘× ×” ×¢×œ ×™×“×™ ×™×•×¡×™ ×©×œ×•× ×¡×× ×›"×œ ×œ×©×›×ª ×¢×•×¨×›×™ ×”×“×™×Ÿ ×‘×™×©×¨××œ</div>
                        </footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
